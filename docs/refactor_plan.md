# 전체 리팩토링 계획 (실시간 업데이트)

## 0. 기본 정보
- 브랜치: `refactor/architecture-cleanup`
- 기준 커밋: `main` @ 9d52e65 이후 `feature/sse-dashboard` 머지 상태
- 문서 목적: 리팩토링 진행 상황, 결정 사항, TODO를 실시간으로 기록

## 1. 현재 진단 요약
- `server/app/main.py`에 라우트/서비스/분석 트리거가 혼재되어 1,100+ 라인
- 파일/분석 서비스가 동기-비동기 혼재 + 반복 로직 존재
- SSE 및 이벤트 매니저 활용이 제한적이며 예외 처리/상태 전파 로직이 분산됨
- 모델/분석기 초기화 코드가 글로벌 스코프에서 실행되어 테스트/DI 어려움
- 구성/경로 상수 관리가 분산(`config.py`, 하드코딩)되어 추적이 어려움

## 2. 리팩토링 목표(우선순위 포함)
1. **FastAPI 애플리케이션 구조화**: 라우터, 서비스, 이벤트, 백그라운드 작업 분리
2. **분석 파이프라인 모듈화**: LSTM/BERT/ML 분석 엔진 인터페이스 표준화, 공통 처리 추출
3. **파일 처리/세션 관리 개선**: 업로드/추출/정리 로직을 서비스 계층으로 이동하고 예외 처리 강화
4. **설정 및 의존성 주입 정리**: 초기화 코드(모델, DB, 서비스)를 팩토리/컨테이너 패턴으로 정돈
5. **테스트/확장성 기반 마련**: 핵심 서비스에 대한 단위 테스트 골격 및 문서화

## 3. 단계별 실행 계획
- **1단계 (분석 & 설계)**
  - [x] 현재 `main.py` 라우트/서비스/유틸 분류 *(아래 "현재 구조 세부 분석" 참고)*
  - [x] 대상 모듈 구조 제안 (`app/api/`, `app/services/`, `app/core/` 등)
  - [x] 문서에 구조 다이어그램 및 책임 정의 추가
- **2단계 (코드 구조 재편)**
  - [x] FastAPI 애플리케이션 팩토리 도입 (`create_app`)
  - [x] 라우트 모듈 분리 (`routers/upload.py`, `routers/dashboard.py`, `routers/session.py` 등)
  - [x] SSE/Event 관련 엔드포인트 분리 및 재사용성 확보
- **3단계 (서비스/분석기 리팩토링)**
  - [x] 파일 서비스/세션 서비스/분석 매니저 클래스화
  - [x] 분석기 인터페이스/팩토리 도입 및 공통 예외 처리
  - [x] 백그라운드 작업 스케줄러 정리 (async + executor 관리)
- **4단계 (설정/의존성)**
  - [x] 설정 모듈 정리 (`config.py` → `app/core/config.py` 등)
  - [x] 서비스 초기화 지점 통일(앱 시작 시 등록)
  - [ ] 테스트/개발/프로덕션 설정 분기 구조 마련
- **5단계 (테스트 & 문서화)**
  - [x] 주요 서비스/라우트 단위 테스트 초안 추가 *(앱 팩토리 스모크 테스트; gensim 미설치 환경에서는 자동 skip)*
  - [ ] `README.md` 및 운영 문서 업데이트
  - [ ] 리팩토링 영향도 및 마이그레이션 가이드 정리

## 4. 리스크 및 고려사항
- 대용량 모델(LFS) 및 로컬 파일 의존성으로 CI 환경 제한 → 테스트 설계 시 모킹 필요
- 기존 VS Code 확장/외부 클라이언트가 엔드포인트 변경 시 영향 받음 → 호환성 검토
- 기존 DB 스키마/데이터 마이그레이션 필요 여부 확인해야 함

## 5. 진행 로그
- 2025-10-02 09:45: 문서 초안 작성, 현재 상태/목표/단계 정의
- 2025-10-02 10:05: `main.py` 구조 세부 분석 추가, 단계별 TODO 보완
- 2025-10-02 10:25: 목표 구조 설계안(B 부록) 작성 및 의존성 흐름 정의
- 2025-10-02 11:10: 앱 팩토리/컨테이너 도입 및 라우터·오케스트레이터 모듈화 완료
- 2025-10-02 12:05: Lazy analyzer/설정 모듈 도입, 테스트 스켈레톤 추가
- 2025-10-02 12:40: 환경 설정 템플릿(.env.example) 추가 및 README에 의존성 안내 갱신

## 부록 A. 현재 구조 세부 분석

### A-1. `server/app/main.py` 주요 블록 (라인 범위 기준)
- 1-120: 앱 초기화, 서비스 인스턴스, 모델 로드 (글로벌 스코프)
- 120-360: 업로드 관련 엔드포인트 (단순 버전, 통합 버전, 모델/모드별 다수 라우트)
- 360-780: 비동기 분석 작업(`analyze_file_integrated_async`, `analyze_file_bert_async`) 및 이벤트 전파
- 780-980: 세션 페이지 라우트(`/session/*`) 및 템플릿 렌더링
- 980-1180: ML 업로드/분석 로직 (동기 호출 포함)
- 1180+: REST API 엔드포인트(`/api/v1/sessions`, `/stats`, etc.)

### A-2. 식별된 문제 지점
1. **글로벌 초기화**: 모델/서비스 인스턴스가 모듈 import 시점에 생성되어 테스트/재로딩 곤란
2. **라우트 중복**: 업로드 라우트가 모델/모드별로 분산되어 로직이 반복
3. **백그라운드 작업 관리 부족**: `asyncio.create_task`와 프로세스 풀 작업이 다양한 위치에서 직접 사용
4. **예외/로그 반복**: 각 엔드포인트가 유사한 예외/로그 패턴을 복제하고 있음
5. **응답/이벤트 형식 분산**: SSE 메시지 구성 로직이 여러 함수에 흩어져 있음

### A-3. 리팩토링 방향 초안
- 앱 팩토리(`create_app`)에서 서비스/모델을 초기화하고 DI 컨테이너에 저장
- 업로드 라우트를 공통 서비스(`UploadService` 가칭)에 위임하고 모델/모드 파라미터만 다루도록 단일화
- 분석 작업 실행은 큐/매니저(`AnalysisOrchestrator`)에서 담당, SSE 전파 로직도 여기서 처리
- 템플릿/REST 라우트를 별도 모듈로 분리하여 데이터 수집/응답 책임 구분

## 부록 B. 타깃 구조 설계

```
server/
  app/
    __init__.py          # create_app 선언, FastAPI 인스턴스 생성
    core/
      config.py          # 설정/환경 변수 로딩
      container.py       # 서비스/모델 의존성 등록
      events.py          # 이벤트 매니저/브로드캐스터 설정
    api/
      routers/
        __init__.py
        upload.py        # 파일 업로드 및 분석 트리거
        sessions.py      # 세션 상세/리스트/REST API
        dashboard.py     # 템플릿 렌더링 뷰
        events.py        # SSE 스트림 엔드포인트
      dependencies.py    # DI 헬퍼/Depends 함수
    services/
      file_service.py    # (기존) 파일 저장/추출 → 클래스화 및 리팩토링
      session_service.py # DB 통계/세션 데이터 제공
      analysis/
        orchestrator.py  # 분석 파이프라인 조정(비동기, SSE, DB 저장)
        engines.py       # LSTM/BERT/ML 엔진 어댑터 정의
    models/              # (현행 유지) 분석기 초기화에 활용
  analysis/              # (엔진 내부 로직 재사용)
```

### B-1. 의존성 흐름
1. `create_app()` → `Config` 로드 → `Container` 초기화 → 서비스 등록
2. 라우터는 `Depends`를 통해 서비스/오케스트레이터 주입받아 작업 실행
3. `AnalysisOrchestrator`는 필요 시 각각의 엔진 어댑터(LSTM/BERT/ML)를 실행하고 `EventManager`를 통해 SSE 전파
4. 파일 추출, DB 저장, 응답 생성은 각 서비스가 담당하며, 라우터는 최소한의 변환만 수행

### B-2. TODO 업데이트
- [x] `app/__init__.py` 초안 작성 (`create_app` + 라우터 include)
- [x] `app/core/container.py`에서 서비스/엔진 등록 스켈레톤 구성
- [x] `app/api/routers/*` 모듈 생성 및 기존 라우트 이관 계획 수립
- [x] `analysis` 모듈 재사용 방식을 명확히(엔진 초기화 vs. 팩토리)

---
※ 변경 시각/내용을 `진행 로그`에 계속 추가하세요.
